<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Admin Dashboard — Manage users, view stats, perform CRUD and bulk email operations for your gallery and auctions." />
  <title>ArtMail Admin — Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Small helpers */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-72 bg-white border-r hidden md:flex flex-col">
      <div class="p-5 border-b">
        <h1 class="text-xl font-semibold">ArtAdmin</h1>
        <p class="text-sm text-slate-500">Gallery & Auction Manager</p>
      </div>
      <nav class="p-4 flex-1">
        <ul class="space-y-2 text-sm">
          <li><button class="w-full text-left p-2 rounded hover:bg-slate-50" data-section="overview">Overview</button></li>
          <li><button class="w-full text-left p-2 rounded hover:bg-slate-50" data-section="users">Users</button></li>
          <li><button class="w-full text-left p-2 rounded hover:bg-slate-50" data-section="emails">Bulk Email</button></li>
          <li><button class="w-full text-left p-2 rounded hover:bg-slate-50" data-section="templates">Templates</button></li>
          <li><button class="w-full text-left p-2 rounded hover:bg-slate-50" data-section="settings">Settings</button></li>
        </ul>
      </nav>
      <div class="p-4 border-t">
        <small class="text-xs text-slate-500">Signed in as Admin</small>
      </div>
    </aside>

    <div class="flex-1 flex flex-col">
      <header class="flex items-center justify-between p-4 bg-white border-b">
        <div class="flex items-center gap-4">
          <button id="mobileMenu" class="md:hidden p-2 rounded hover:bg-slate-100">☰</button>
          <h2 class="text-lg font-medium">Dashboard</h2>
        </div>
        <div class="flex items-center gap-3">
          <input id="globalSearch" placeholder="Search users, emails..." class="rounded border px-3 py-2 text-sm"/>
          <button id="logout" class="px-3 py-2 border rounded text-sm">Logout</button>
        </div>
      </header>

      <main class="p-4 overflow-auto">
        <!-- Overview section -->
        <section id="overview" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded shadow-sm">
              <p class="text-sm text-slate-500">Total Users</p>
              <h3 id="totalUsers" class="text-2xl font-semibold">0</h3>
            </div>
            <div class="bg-white p-4 rounded shadow-sm">
              <p class="text-sm text-slate-500">Active in Last 30d</p>
              <h3 id="active30" class="text-2xl font-semibold">0</h3>
            </div>
            <div class="bg-white p-4 rounded shadow-sm">
              <p class="text-sm text-slate-500">Registered Today</p>
              <h3 id="todayReg" class="text-2xl font-semibold">0</h3>
            </div>
            <div class="bg-white p-4 rounded shadow-sm">
              <p class="text-sm text-slate-500">Emails Sent (Total)</p>
              <h3 id="emailsSent" class="text-2xl font-semibold">0</h3>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded shadow-sm lg:col-span-2">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-medium">User Growth (30 days)</h4>
                <small class="text-sm text-slate-500">Last 30 days</small>
              </div>
              <canvas id="growthChart" height="120"></canvas>
            </div>

            <div class="bg-white p-4 rounded shadow-sm">
              <h4 class="font-medium mb-2">Top Locations</h4>
              <ul id="topLocations" class="text-sm space-y-2 text-slate-600"></ul>
            </div>
          </div>
        </section>

        <!-- Users Management -->
        <section id="users" class="hidden mt-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Users</h3>
            <div class="flex items-center gap-2">
              <button id="addUserBtn" class="px-3 py-2 bg-indigo-600 text-white rounded">Add User</button>
              <button id="bulkEmailBtn" class="px-3 py-2 border rounded">Send Bulk Email</button>
            </div>
          </div>

          <div class="bg-white rounded shadow overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-50">
                <tr class="text-left">
                  <th class="p-3">#</th>
                  <th class="p-3">Name</th>
                  <th class="p-3">Email</th>
                  <th class="p-3">Joined</th>
                  <th class="p-3">Status</th>
                  <th class="p-3">Actions</th>
                </tr>
              </thead>
              <tbody id="usersTable"></tbody>
            </table>
          </div>

          <div class="mt-3 flex items-center justify-between">
            <div>
              <button id="exportCsv" class="px-3 py-1 border rounded text-sm">Export CSV</button>
            </div>
            <div class="flex items-center gap-2">
              <button id="prevUsers" class="px-3 py-1 border rounded">Prev</button>
              <button id="nextUsers" class="px-3 py-1 border rounded">Next</button>
            </div>
          </div>
        </section>

        <!-- Bulk Email & Templates -->
        <section id="emails" class="hidden mt-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Bulk Email</h3>
            <div class="flex items-center gap-2">
              <select id="chooseTemplate" class="rounded border px-2 py-1 text-sm">
                <option value="default">Select Template</option>
              </select>
              <button id="previewTemplate" class="px-3 py-2 border rounded">Preview</button>
              <button id="sendBulk" class="px-3 py-2 bg-indigo-600 text-white rounded">Send</button>
            </div>
          </div>

          <div class="bg-white p-4 rounded shadow text-sm text-slate-600">
            <p class="mb-2">You can send bulk emails to a selection of users. Provide user list via API (name, email). The backend handles templates and sending. Below is a preview area:</p>
            <textarea id="bulkPreview" class="w-full rounded border p-2" rows="6" placeholder="Bulk recipients list (name,email per line)">John Doe,john@example.com</textarea>
          </div>
        </section>

        <section id="templates" class="hidden mt-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Email Templates</h3>
            <button id="syncTemplates" class="px-3 py-2 border rounded">Sync from Backend</button>
          </div>
          <div id="templatesList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
        </section>

      </main>

      <footer class="p-3 text-center text-sm text-slate-500">© <span id="year"></span> ArtAdmin — Manage your gallery</footer>
    </div>
  </div>

  <!-- Modals: Add/Edit User, Confirm Delete, Bulk send status -->
  <div id="modalWrap" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50 p-4">
    <div id="modal" class="bg-white rounded shadow p-4 w-full max-w-2xl"></div>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    try {
      // DEMO state - replace with your API calls
      const state = {
        users: [],
        page: 1,
        perPage: 8,
        totalSent: 0,
        templates: [
          { id: 't1', name: 'Auction Invite', preview: `Dear {name},\nJoin our live auction...` },
          { id: 't2', name: 'New Collection', preview: `Hello {name},\nWe have new artworks available.` }
        ]
      };

      // Cached elements
      const modalWrap = document.getElementById('modalWrap');
      const modalEl = document.getElementById('modal');
      const chooseTemplate = document.getElementById('chooseTemplate');
      const bulkPreview = document.getElementById('bulkPreview');

      // Utilities
      const escapeHtml = (s) => (s + '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

      // Seed demo users
      function seedUsers() {
        for (let i = 1; i <= 37; i++) {
          state.users.push({
            id: i,
            name: `Client ${i}`,
            email: `client${i}@example.com`,
            joined: new Date(Date.now() - i * 86400000).toISOString().slice(0, 10),
            status: i % 4 === 0 ? 'inactive' : 'active'
          });
        }
      }

      // Overview
      function renderOverview() {
        const totalUsersEl = document.getElementById('totalUsers');
        const active30El = document.getElementById('active30');
        const todayRegEl = document.getElementById('todayReg');
        const emailsSentEl = document.getElementById('emailsSent');
        if (totalUsersEl) totalUsersEl.textContent = state.users.length;
        if (active30El) active30El.textContent = state.users.filter(u => (new Date() - new Date(u.joined)) < 30 * 24 * 3600 * 1000).length;
        if (todayRegEl) todayRegEl.textContent = state.users.filter(u => u.joined === new Date().toISOString().slice(0, 10)).length;
        if (emailsSentEl) emailsSentEl.textContent = state.totalSent;
      }

      // Users table
      function renderUsers() {
        const tbody = document.getElementById('usersTable');
        if (!tbody) return;
        tbody.innerHTML = '';
        const start = (state.page - 1) * state.perPage;
        const slice = state.users.slice(start, start + state.perPage);
        slice.forEach((u, idx) => {
          const tr = document.createElement('tr');
          tr.className = 'border-t';
          tr.innerHTML = `
            <td class="p-3">${start + idx + 1}</td>
            <td class="p-3">${escapeHtml(u.name)}</td>
            <td class="p-3">${escapeHtml(u.email)}</td>
            <td class="p-3">${u.joined}</td>
            <td class="p-3">${u.status}</td>
            <td class="p-3">
              <button data-id="${u.id}" class="editBtn px-2 py-1 rounded border text-sm">Edit</button>
              <button data-id="${u.id}" class="delBtn px-2 py-1 rounded border text-sm text-red-600">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Chart
      let growthChartInstance = null;
      function renderChart() {
        const canvas = document.getElementById('growthChart');
        if (!canvas) return;
        const labels = Array.from({ length: 30 }).map((_, i) => `Day ${i + 1}`);
        const data = labels.map(() => Math.floor(Math.random() * 5));
        if (growthChartInstance) {
          try { growthChartInstance.destroy(); } catch (e) { /* ignore */ }
        }
        const ctx = canvas.getContext('2d');
        growthChartInstance = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: 'New users', data, fill: true, tension: 0.3 }] },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
      }

      // Templates
      function renderTemplates() {
        if (chooseTemplate) {
          chooseTemplate.innerHTML = '<option value="default">Select Template</option>';
          state.templates.forEach(t => {
            chooseTemplate.innerHTML += `<option value="${t.id}">${escapeHtml(t.name)}</option>`;
          });
        }
        const list = document.getElementById('templatesList');
        if (!list) return;
        list.innerHTML = '';
        state.templates.forEach(t => {
          // convert newlines to <br> for preview display
          const previewHtml = escapeHtml(t.preview).replace(/\n/g, '<br>');
          list.innerHTML += `<div class="bg-white p-3 rounded shadow"><h4 class="font-medium">${escapeHtml(t.name)}</h4><p class="text-sm text-slate-600 mt-2">${previewHtml}</p></div>`;
        });
      }

      // Event delegation for edit/delete
      document.addEventListener('click', (e) => {
        const delBtn = e.target.closest('.delBtn');
        const editBtn = e.target.closest('.editBtn');
        if (delBtn) { const id = +delBtn.dataset.id; openConfirmDelete(id); }
        if (editBtn) { const id = +editBtn.dataset.id; openEditUser(id); }
      });

      // Safe bindings
      const addUserBtn = document.getElementById('addUserBtn'); if (addUserBtn) addUserBtn.addEventListener('click', openAddUser);
      const bulkEmailBtn = document.getElementById('bulkEmailBtn'); if (bulkEmailBtn) bulkEmailBtn.addEventListener('click', () => showSection('emails'));
      const sendBulkBtn = document.getElementById('sendBulk'); if (sendBulkBtn) sendBulkBtn.addEventListener('click', sendBulk);
      const previewTemplateBtn = document.getElementById('previewTemplate'); if (previewTemplateBtn) previewTemplateBtn.addEventListener('click', previewTemplate);
      const syncTemplatesBtn = document.getElementById('syncTemplates'); if (syncTemplatesBtn) syncTemplatesBtn.addEventListener('click', () => { alert('Syncing templates from backend (demo)'); });
      const exportCsvBtn = document.getElementById('exportCsv'); if (exportCsvBtn) exportCsvBtn.addEventListener('click', exportCSV);
      const prevUsersBtn = document.getElementById('prevUsers'); if (prevUsersBtn) prevUsersBtn.addEventListener('click', () => { if (state.page > 1) { state.page--; renderUsers(); } });
      const nextUsersBtn = document.getElementById('nextUsers'); if (nextUsersBtn) nextUsersBtn.addEventListener('click', () => { if ((state.page * state.perPage) < state.users.length) { state.page++; renderUsers(); } });

      // Modal helpers
      function openModal(html) {
        if (!modalWrap || !modalEl) return;
        modalEl.innerHTML = html;
        modalWrap.classList.remove('hidden');
      }
      function closeModal() {
        if (!modalWrap || !modalEl) return;
        modalWrap.classList.add('hidden');
        modalEl.innerHTML = '';
      }

      if (modalWrap) {
        modalWrap.addEventListener('click', (e) => { if (e.target === modalWrap) closeModal(); });
      }

      // CRUD modals
      function openConfirmDelete(id) {
        openModal(`
          <h3 class="text-lg font-semibold mb-2">Confirm delete</h3>
          <p class="mb-4">Delete user permanently?</p>
          <div class="flex gap-2">
            <button id="confirmDel" class="px-3 py-2 bg-red-600 text-white rounded">Delete</button>
            <button id="cancelDel" class="px-3 py-2 border rounded">Cancel</button>
          </div>
        `);
        const confirmDel = document.getElementById('confirmDel'); if (confirmDel) confirmDel.addEventListener('click', () => {
          state.users = state.users.filter(u => u.id !== id);
          renderUsers(); renderOverview(); closeModal();
          alert('User deleted (demo). Connect your DELETE /api/users/:id');
        });
        const cancelDel = document.getElementById('cancelDel'); if (cancelDel) cancelDel.addEventListener('click', closeModal);
      }

      function openAddUser() {
        openModal(`
          <h3 class="text-lg font-semibold mb-2">Add user</h3>
          <form id="addUserForm" class="space-y-3">
            <input required id="u_name" class="w-full rounded border px-3 py-2" placeholder="Name" />
            <input required id="u_email" class="w-full rounded border px-3 py-2" placeholder="Email" />
            <div class="flex gap-2">
              <button class="px-3 py-2 bg-indigo-600 text-white rounded">Save</button>
              <button type="button" id="cancelAdd" class="px-3 py-2 border rounded">Cancel</button>
            </div>
          </form>
        `);
        const cancelAdd = document.getElementById('cancelAdd'); if (cancelAdd) cancelAdd.addEventListener('click', closeModal);
        const addForm = document.getElementById('addUserForm'); if (addForm) addForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const name = document.getElementById('u_name').value.trim();
          const email = document.getElementById('u_email').value.trim();
          const id = (state.users[0]?.id || 0) + 1;
          state.users.unshift({ id, name, email, joined: new Date().toISOString().slice(0, 10), status: 'active' });
          renderUsers(); renderOverview(); closeModal();
          alert('User added (demo). Implement POST /api/users');
        });
      }

      function openEditUser(id) {
        const u = state.users.find(x => x.id === id);
        if (!u) { alert('User not found'); return; }
        openModal(`
          <h3 class="text-lg font-semibold mb-2">Edit user</h3>
          <form id="editUserForm" class="space-y-3">
            <input required id="e_name" class="w-full rounded border px-3 py-2" value="${escapeHtml(u.name)}" />
            <input required id="e_email" class="w-full rounded border px-3 py-2" value="${escapeHtml(u.email)}" />
            <div class="flex gap-2">
              <button class="px-3 py-2 bg-indigo-600 text-white rounded">Save</button>
              <button type="button" id="cancelEdit" class="px-3 py-2 border rounded">Cancel</button>
            </div>
          </form>
        `);
        const cancelEdit = document.getElementById('cancelEdit'); if (cancelEdit) cancelEdit.addEventListener('click', closeModal);
        const editForm = document.getElementById('editUserForm'); if (editForm) editForm.addEventListener('submit', (e) => {
          e.preventDefault();
          u.name = document.getElementById('e_name').value.trim();
          u.email = document.getElementById('e_email').value.trim();
          renderUsers(); renderOverview(); closeModal();
          alert('User updated (demo). Implement PUT /api/users/:id');
        });
      }

      // Bulk send
      function sendBulk() {
        if (!bulkPreview) { alert('Bulk preview area not found'); return; }
        const text = bulkPreview.value || '';
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        if (!lines.length) { alert('Add recipients'); return; }

        // Parse lines: support "Name,email" or just "email"
        const recipients = lines.map(line => {
          const parts = line.split(',').map(s => s.trim());
          if (parts.length >= 2) return { name: parts[0], email: parts[1] };
          return { name: '', email: parts[0] };
        });

        // TODO: POST /api/admin/emails/bulk { templateId, recipients }
        state.totalSent += recipients.length;
        renderOverview();
        alert(`${recipients.length} emails queued to send (demo). Implement POST /api/emails/bulk`);
      }

      function previewTemplate() {
        if (!chooseTemplate) { alert('Template selector missing'); return; }
        const t = chooseTemplate.value;
        if (t === 'default') { alert('Choose a template'); return; }
        const tpl = state.templates.find(x => x.id === t);
        if (!tpl) { alert('Template not found'); return; }
        // show preview with newlines
        alert('Template preview:\n\n' + tpl.preview);
      }

      function exportCSV() {
        const rows = [['Name', 'Email', 'Joined', 'Status']].concat(state.users.map(u => [u.name, u.email, u.joined, u.status]));
        const csv = rows.map(r => r.map(c => `"${(c + '').replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'users.csv'; a.click(); URL.revokeObjectURL(url);
      }

      // Navigation helper
      function showSection(id) {
        const sections = document.querySelectorAll('main section');
        if (!sections || !sections.length) return;
        sections.forEach(sec => sec.classList.add('hidden'));
        const sel = document.getElementById(id);
        if (sel) sel.classList.remove('hidden');
      }
      const navButtons = document.querySelectorAll('aside button[data-section]');
      if (navButtons && navButtons.length) navButtons.forEach(btn => btn.addEventListener('click', () => showSection(btn.dataset.section)));

      // Init
      seedUsers(); renderOverview(); renderUsers(); renderChart(); renderTemplates();
      const yearEl = document.getElementById('year'); if (yearEl) yearEl.textContent = new Date().getFullYear();
      showSection('overview');

    } catch (err) {
      console.error('Initialization error', err);
      alert('Initialization error — open console for details');
    }
  });
</script>
</body>
</html>
